name: ðŸªŸ Windows Exports Tests
on:
  push:
    branches:
      - master

jobs:
  test-windows-exports:
    runs-on: windows-latest
    permissions:
      contents: write
    name: "win-export"
    steps:
      - name: Git checkout
        uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/master' }}

      - name: Build project
        run: |
          ./gradlew build -P17

      - name: Create JRE
        run: |
          jlink --add-modules java.base,java.logging --output jvm/jre-amd64-windows



      - name: Download Godot-Kotlin-Jvm binary
        run: |
          Invoke-WebRequest -Uri "https://github.com/utopia-rise/godot-kotlin-jvm/releases/download/0.13.1-4.4.1/godot-kotlin-jvm_editor_windows_x86_64_release_0.13.1-4.4.1.zip" -OutFile "godot-kotlin-jvm_editor_windows_x86_64_release_0.13.1-4.4.1.zip"
          Expand-Archive -Path godot-kotlin-jvm_editor_windows_x86_64_release_0.13.1-4.4.1.zip -DestinationPath .

      - name: Download Godot-Kotlin-Jvm export template
        run: |
          Invoke-WebRequest -Uri "https://github.com/utopia-rise/godot-kotlin-jvm/releases/download/0.13.1-4.4.1/godot-kotlin-jvm_export_templates_0.13.1-4.4.1.tpz" -OutFile "godot-kotlin-jvm_export_templates_0.13.1-4.4.1.tpz"
          mkdir export_templates
          Expand-Archive -Path godot-kotlin-jvm_export_templates_0.13.1-4.4.1.tpz -DestinationPath ./export_templates

      - name: Run Godot export
        shell: pwsh
        run: |
          mkdir export
          Add-MpPreference -ExclusionPath "${{ github.workspace }}"
          Add-MpPreference -ExclusionProcess "godot.windows.editor.x86_64.jvm.0.13.1.console.exe"
          ./godot.windows.editor.x86_64.jvm.0.13.1.console.exe --headless --export-release "Windows Desktop" export/game.exe

      - name: Upload to Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          Compress-Archive -Path ./export/* -DestinationPath game.zip
          dir
          dir ./export
          gh release create ${{ github.ref_name }} game.zip --notes "Automated release"
